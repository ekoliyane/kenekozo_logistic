<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kenekozo Logistics System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS (Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- LZString (Kompresi Link) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <!-- jsPDF & AutoTable (Untuk PDF Keren) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #map { height: 250px; width: 100%; border-radius: 0.5rem; z-index: 1; }
        #driver-map { height: 280px; width: 100%; border-radius: 0.5rem; z-index: 1; margin-bottom: 1rem; }
        .tier-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .task-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 4px; }
        .task-deliv { background-color: #e0e7ff; color: #3730a3; } 
        .task-pick { background-color: #fce7f3; color: #9d174d; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <nav class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2"><i data-lucide="truck"></i> Kenekozo</h1>
            <div class="flex bg-indigo-900 rounded-lg p-1">
                <button onclick="switchRole('admin')" id="btn-admin" class="px-3 py-1 rounded-md text-sm font-medium bg-white text-indigo-900 shadow">Admin</button>
                <button onclick="switchRole('driver')" id="btn-driver" class="px-3 py-1 rounded-md text-sm font-medium text-gray-300 hover:text-white">Sopir</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-lg mb-20">

        <!-- VIEW: ADMIN -->
        <div id="view-admin">
            <div class="flex justify-between items-center mb-4 text-xs text-gray-500">
                <div class="flex items-center gap-2">
                    <i data-lucide="phone" class="w-3 h-3"></i>
                    <input type="text" id="admin-phone" class="bg-transparent border-b border-gray-300 outline-none w-28" placeholder="No WA Admin" value="6285185015196">
                </div>
                <button onclick="resetAll()" class="text-red-500 underline">Reset Data</button>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-indigo-100">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="clipboard-paste" class="text-indigo-600 w-5 h-5"></i>
                    <h2 class="text-md font-bold text-indigo-900">Import Pesanan (WA)</h2>
                </div>
                <textarea id="bulk-input" rows="5" class="w-full p-3 text-xs border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-mono bg-gray-50" placeholder="Paste detail pesanan lengkap di sini..."></textarea>
                <button onclick="parseBulkInput()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold shadow-sm text-sm flex justify-center items-center gap-2">
                    <i data-lucide="wand-2" class="w-4 h-4"></i> PROSES DATA
                </button>
            </div>

            <!-- Manual Toggle -->
            <details class="mb-4" open>
                <summary class="text-xs font-bold text-gray-500 cursor-pointer mb-2">Peta & Opsi Manual</summary>
                <div class="bg-white p-3 rounded-xl border border-gray-200">
                    <div id="map" class="mb-3"></div>
                    <p class="text-[10px] text-gray-400 text-center mb-2">Klik peta untuk ambil koordinat</p>
                    <div class="space-y-2">
                        <input type="text" id="cust-name" class="w-full p-2 border rounded text-xs" placeholder="Nama Customer">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="cust-size" class="w-full p-2 border rounded text-xs bg-white">
                                <option value="small">Kecil (10rb)</option>
                                <option value="medium">Sedang (15rb)</option>
                                <option value="large">Besar (25rb)</option>
                            </select>
                            <input type="text" id="cust-coord" readonly class="w-full p-2 border rounded text-xs bg-gray-100" placeholder="Lat, Lng">
                        </div>
                        <button onclick="addStopManual()" class="w-full bg-gray-500 text-white py-2 rounded text-xs font-bold">Tambah Manual</button>
                    </div>
                </div>
            </details>

            <!-- Draft List -->
            <div id="draft-list" class="bg-white p-4 rounded-xl shadow-sm mb-4 hidden">
                <h3 class="font-bold text-gray-800 mb-2 border-b pb-2">Review Rute</h3>
                <ul id="stops-ul" class="space-y-3 text-sm mb-4"></ul>
                <button onclick="generateMission()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2">
                    <i data-lucide="calculator" class="w-5 h-5"></i> HITUNG & BUAT LINK
                </button>
            </div>

            <!-- Result Link -->
            <div id="share-section" class="hidden bg-green-50 p-4 rounded-xl border border-green-200 mt-4">
                <h3 class="font-bold text-green-800 flex items-center gap-2 mb-2"><i data-lucide="link" class="w-4 h-4"></i> Link Misi</h3>
                
                <!-- Salary Slip Button -->
                <button onclick="openSalaryModal()" class="w-full bg-white border border-indigo-300 text-indigo-700 py-2 rounded mb-3 text-sm font-bold hover:bg-indigo-50 flex justify-center items-center gap-2 shadow-sm">
                    <i data-lucide="banknote" class="w-4 h-4"></i> BUAT STRUK GAJI (Admin)
                </button>

                <!-- Shorten Button -->
                <button onclick="tryShortenLink()" class="w-full bg-indigo-100 text-indigo-700 py-2 rounded mb-2 text-xs font-bold hover:bg-indigo-200 flex justify-center items-center gap-1">
                    <i data-lucide="scissors" class="w-3 h-3"></i> Buat Link Pendek (TinyURL)
                </button>
                <p id="shorten-warning" class="hidden text-[10px] text-red-500 mb-2 text-center bg-red-50 p-1 rounded">
                    ‚ö†Ô∏è Link komputer (file://) tidak bisa dipendekkan. Gunakan "Copy Kode Manual" di bawah.
                </p>

                <div class="flex gap-2 mb-2">
                    <input type="text" id="share-link-input" readonly class="w-full p-2 text-xs border rounded bg-white text-gray-500">
                    <button onclick="copyShareLink()" class="bg-green-600 text-white px-3 py-2 rounded font-bold text-xs whitespace-nowrap hover:bg-green-700">Salin</button>
                </div>
                
                <a id="wa-share-btn" href="#" target="_blank" class="block text-center bg-white border border-green-500 text-green-600 py-2 rounded-lg text-xs font-bold hover:bg-green-50">Kirim ke WA Panggih ‚û°Ô∏è</a>
                
                <!-- Backup Manual Code -->
                <div class="mt-3 bg-white p-3 rounded border border-gray-200 shadow-sm">
                    <p class="text-xs font-bold text-gray-700 mb-1 flex items-center gap-1"><i data-lucide="code" class="w-3 h-3"></i> KODE MANUAL (Hemat Karakter)</p>
                    <p class="text-[10px] text-gray-500 mb-1">Jika link error, copy kode ini & minta driver paste di menu 'Load Manual':</p>
                    <textarea id="manual-code-area" readonly class="w-full h-16 text-[10px] bg-gray-100 p-1 font-mono rounded border-gray-300"></textarea>
                    <button onclick="copyManualCode()" class="w-full bg-gray-200 text-xs py-2 rounded mt-1 font-bold hover:bg-gray-300">Copy Kode</button>
                </div>
            </div>
        </div>

        <!-- VIEW: DRIVER -->
        <div id="view-driver" class="hidden">
            <!-- No Mission State -->
            <div id="no-mission" class="text-center py-10 text-gray-400">
                <i data-lucide="truck" class="w-16 h-16 mx-auto mb-2 text-gray-200"></i>
                <p>Belum ada misi.</p>
                <div class="mt-4 px-8">
                    <p class="text-xs text-gray-400 mb-2">Paste kode manual dari Bu Lya:</p>
                    <textarea id="driver-paste-area" class="w-full border rounded p-2 text-xs h-16" placeholder="Paste kode di sini..."></textarea>
                    <button onclick="loadManualCode()" class="w-full bg-indigo-600 text-white py-2 rounded text-xs font-bold mt-1">Load Data</button>
                </div>
            </div>

            <!-- Active Mission Card -->
            <div id="active-mission-card" class="hidden">
                <div class="bg-gray-900 text-white p-4 rounded-t-xl flex justify-between items-center sticky top-16 z-40">
                    <div>
                        <p class="font-bold text-sm" id="m-date">-</p>
                        <p id="m-start-time" class="text-xs text-green-400 mt-1 hidden font-mono">üöÄ Mulai: --:--</p>
                        <p id="m-end-time" class="text-xs text-blue-400 mt-1 hidden font-mono">üèÅ Selesai: --:--</p>
                    </div>
                    <span id="m-status-badge" class="bg-yellow-400 text-xs px-2 py-1 rounded font-bold text-black">PENDING</span>
                </div>

                <div class="bg-white rounded-b-xl shadow-lg border-x border-b border-gray-200 overflow-hidden mb-6">
                    <!-- Map -->
                    <div class="p-3 bg-gray-50 border-b">
                         <div id="driver-map"></div>
                         <div class="flex justify-between items-center mt-2 text-xs text-gray-600">
                             <span>Jarak: <b><span id="m-dist">0</span> km</b></span>
                             <button onclick="toggleTariffInfo()" class="text-indigo-600 font-bold underline">Info Tarif</button>
                         </div>
                    </div>

                    <!-- Payment Summary -->
                    <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold">Total Terima</p>
                            <h2 class="text-2xl font-bold text-indigo-700" id="m-total-pay">Rp 0</h2>
                        </div>
                        <div class="text-right text-xs space-y-1 text-gray-600">
                            <p>üöó Jln: <b id="pay-drive">0</b></p>
                            <p>üí™ Otot: <b id="pay-load">0</b></p>
                            <p>üç± Makan: <b>20rb</b></p>
                        </div>
                    </div>

                    <!-- Action Buttons (START/PENDING) -->
                    <div class="p-4 flex gap-3 border-b" id="action-buttons">
                        <button onclick="updateMissionStatus('REJECTED')" class="flex-1 border border-red-200 text-red-600 py-3 rounded-lg text-sm font-bold hover:bg-red-50">Tolak</button>
                        <div class="flex-1 flex flex-col gap-1">
                            <button onclick="updateMissionStatus('ACCEPTED')" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 flex justify-center items-center gap-2">
                                <span>MULAI JALAN</span> üöÄ
                            </button>
                            <p class="text-[10px] text-gray-400 text-center">Klik saat kendaraan siap berangkat</p>
                        </div>
                    </div>
                    
                    <!-- Back to Garage Button (NEW) -->
                    <div id="finish-garage-btn" class="hidden p-4 border-b border-indigo-100 bg-yellow-50">
                        <div class="flex flex-col gap-1">
                            <button onclick="updateMissionStatus('COMPLETED')" class="w-full bg-green-600 text-white py-3 rounded-lg text-sm font-bold shadow hover:bg-green-700 flex justify-center items-center gap-2">
                                <span>TIBA DI GARASI (SELESAI)</span> üèÅ
                            </button>
                            <p class="text-[10px] text-green-700 text-center">Klik saat mobil sudah parkir di garasi kembali</p>
                        </div>
                    </div>

                    <!-- Finish & Report Area (COMPLETED) -->
                    <div id="finish-form" class="hidden p-4 bg-green-50 text-center border-b border-green-100">
                        <div class="mb-3 bg-white p-3 rounded border border-green-200 text-left">
                            <p class="text-sm font-bold text-green-800 text-center mb-2">Misi Selesai! üéâ</p>
                            <p class="text-[10px] text-green-600 text-center">Mobil kembali: <span id="finish-time-display" class="font-mono font-bold">-</span></p>
                            <p class="text-xs font-bold text-indigo-700 mt-1 text-center mb-3" id="total-duration-display">‚è±Ô∏è Durasi: -</p>
                            
                            <!-- DRIVER NOTES INPUT -->
                            <hr class="border-green-100 mb-2">
                            <label class="block text-xs font-bold text-gray-700 mb-1">Catatan Keuangan & Operasional:</label>
                            <textarea id="driver-notes" oninput="saveDriverNotes()" class="w-full p-2 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-green-500 outline-none" rows="3" placeholder="Contoh: Beli bensin 50rb, Tambal ban 20rb, Terima uang cash dari Bu Ani 200rb..."></textarea>
                            <p class="text-[10px] text-gray-400 mt-1">*Tulis pengeluaran atau uang yang diterima tunai.</p>
                        </div>

                        <div class="flex gap-2 flex-col">
                            <button onclick="sendFinishWA()" class="w-full bg-green-500 text-white py-2 rounded-lg text-sm font-bold hover:bg-green-600 flex justify-center items-center gap-2">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> Lapor via WA
                            </button>
                            <div class="flex gap-2">
                                <!-- TOMBOL DOWNLOAD PDF -->
                                <button onclick="downloadPDFReport()" class="flex-1 bg-white border border-red-600 text-red-600 py-2 rounded-lg text-sm font-bold flex justify-center items-center gap-2 hover:bg-red-50">
                                    <i data-lucide="file-text" class="w-4 h-4"></i> Unduh PDF
                                </button>
                                <button onclick="resetAll()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-700">Tutup</button>
                            </div>
                        </div>
                    </div>

                    <!-- Stops List -->
                    <div class="bg-gray-50 p-2">
                        <div class="bg-yellow-50 border border-yellow-200 p-2 text-xs text-yellow-800 rounded mb-2 flex items-start gap-2">
                            <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                            <div>
                                <b>Tips Pantau:</b> Sopir cukup kirim <b>Live Location</b> di WA saat berangkat. Centang tugas di sini tanpa perlu lapor tiap titik.
                            </div>
                        </div>
                        <h3 class="font-bold text-gray-500 text-xs px-2 py-2">DAFTAR TUJUAN</h3>
                        <div id="driver-stops-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL INFO TARIF -->
        <div id="tariff-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full max-h-[80vh] overflow-y-auto">
                <div class="bg-gray-800 p-3 sticky top-0 flex justify-between items-center text-white">
                    <h3 class="font-bold text-sm">Kamus Ongkos Otot</h3>
                    <button onclick="toggleTariffInfo()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-4 text-xs space-y-4">
                    <div class="border-l-4 border-green-500 pl-2">
                        <b class="text-green-700">RINGAN (Rp 10.000)</b>
                        <p class="text-gray-500">Freezer 4 Rak, Showcase 140L, Box 100-200L, Kulkas 1 Pintu</p>
                    </div>
                    <div class="border-l-4 border-yellow-500 pl-2">
                        <b class="text-yellow-700">SEDANG (Rp 15.000)</b>
                        <p class="text-gray-500">Freezer 6 Rak, Showcase 230-280L, Box 300-400L, Sliding Kaca</p>
                    </div>
                    <div class="border-l-4 border-red-500 pl-2">
                        <b class="text-red-700">BERAT (Rp 25.000)</b>
                        <p class="text-gray-500">Box 500-750 Liter (Jumbo)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL EDIT STOP -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[70] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center border-b pb-2 mb-3">
                    <h3 class="font-bold text-lg text-indigo-900">Edit Data Tujuan</h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <input type="hidden" id="edit-index">
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Nama Customer</label>
                        <input type="text" id="edit-name" class="w-full p-2 border rounded text-sm font-bold focus:ring-2 ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Alamat</label>
                        <textarea id="edit-address" rows="2" class="w-full p-2 border rounded text-xs focus:ring-2 ring-indigo-500 outline-none"></textarea>
                    </div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-200">
                        <label class="block text-xs font-bold text-blue-800 mb-1">Lokasi Peta (Koordinat)</label>
                        <div class="flex gap-2">
                            <input type="text" id="edit-latlng" class="w-full p-2 border rounded text-xs bg-white text-gray-600" placeholder="-7.xxx, 110.xxx" readonly>
                        </div>
                        <div class="mt-2 text-[10px] text-blue-600 flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-3 h-3"></i>
                            <span>Klik langsung di Peta Utama untuk update titik!</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Ongkos Otot (Rp)</label>
                        <input type="number" id="edit-fee" class="w-full p-2 border rounded text-sm focus:ring-2 ring-indigo-500 outline-none">
                    </div>
                </div>

                <div class="flex gap-2 mt-5">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-xs hover:bg-gray-300">Batal</button>
                    <button onclick="saveEditStop()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold text-xs hover:bg-indigo-700 shadow-md">Simpan Perubahan</button>
                </div>
            </div>
        </div>

        <!-- NEW: MODAL EDIT GAJI (SALARY SLIP) -->
        <div id="salary-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto flex flex-col">
                <div class="bg-indigo-800 p-4 sticky top-0 flex justify-between items-center text-white">
                    <div class="flex items-center gap-2">
                        <i data-lucide="file-edit" class="w-5 h-5"></i>
                        <h3 class="font-bold text-sm">Editor Struk Gaji</h3>
                    </div>
                    <button onclick="closeSalaryModal()" class="hover:text-red-300"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                
                <div class="p-5 flex-1 overflow-y-auto">
                    <p class="text-[10px] text-gray-500 mb-3 bg-indigo-50 p-2 rounded border border-indigo-100">
                        üí° Data ini hanya untuk cetak struk PDF di sini. Tidak mengubah link driver.
                    </p>

                    <div class="space-y-3">
                        <!-- Uang Jalan -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Uang Jalan (Jarak)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-xs text-gray-500">Rp</span>
                                <input type="number" id="slip-drive" class="w-full pl-8 p-2 border rounded text-sm bg-gray-50 focus:bg-white focus:ring-1 ring-indigo-500 outline-none" oninput="calculateSalaryTotal()">
                            </div>
                        </div>

                        <!-- Uang Otot -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Ongkos Otot (Muatan)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-xs text-gray-500">Rp</span>
                                <input type="number" id="slip-load" class="w-full pl-8 p-2 border rounded text-sm bg-gray-50 focus:bg-white focus:ring-1 ring-indigo-500 outline-none" oninput="calculateSalaryTotal()">
                            </div>
                        </div>

                        <!-- Uang Makan -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Uang Makan</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-xs text-gray-500">Rp</span>
                                <input type="number" id="slip-meal" class="w-full pl-8 p-2 border rounded text-sm bg-gray-50 focus:bg-white focus:ring-1 ring-indigo-500 outline-none" oninput="calculateSalaryTotal()">
                            </div>
                        </div>

                        <!-- Penyesuaian -->
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <label class="block text-xs font-bold text-yellow-800 mb-1">Penyesuaian (+/-)</label>
                            <input type="text" id="slip-adj-desc" placeholder="Keterangan (mis: Bonus/Kasbon)" class="w-full p-2 mb-2 border rounded text-xs bg-white outline-none">
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-xs text-gray-500">Rp</span>
                                <input type="number" id="slip-adj-val" placeholder="0" class="w-full pl-8 p-2 border rounded text-sm bg-white focus:ring-1 ring-yellow-500 outline-none" oninput="calculateSalaryTotal()">
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1">Gunakan tanda minus (-) untuk potongan.</p>
                        </div>

                        <!-- Catatan -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Catatan Admin</label>
                            <textarea id="slip-note" rows="2" class="w-full p-2 border rounded text-xs bg-gray-50 focus:bg-white outline-none" placeholder="Pesan untuk sopir..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-gray-100 border-t sticky bottom-0">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm font-bold text-gray-600">Total Terima:</span>
                        <span id="slip-total-display" class="text-xl font-bold text-indigo-700">Rp 0</span>
                    </div>
                    <button onclick="printSalarySlip()" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2">
                        <i data-lucide="printer" class="w-5 h-5"></i> CETAK PDF STRUK
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification (Popup Kecil) -->
        <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-xs hidden z-50 transition-opacity duration-300">
            ‚úÖ Status tersimpan (Offline)
        </div>

    </div>

    <script>
        const PRICES = { perKM: 1000, meal: 20000, load: { small: 10000, medium: 15000, large: 25000 } };
        const WAREHOUSE = { name: "Gudang Kenekozo", lat: -7.640133, lng: 110.254388 };
        let currentRole = 'admin';
        let map, driverMap;
        let adminMarkers = []; 
        let stops = []; 
        let activeMission = null;
        let selectedCoords = null;
        let editMarker = null; // Marker sementara saat edit

        window.onload = function() {
            initAdminMap();
            const urlParams = new URLSearchParams(window.location.search);
            const missionData = urlParams.get('d'); 
            if (missionData) {
                try {
                    const jsonStr = LZString.decompressFromEncodedURIComponent(missionData);
                    if(jsonStr) {
                        const parsed = JSON.parse(jsonStr);
                        // Check if minified (version 2) or legacy
                        activeMission = parsed.v === 2 ? expandMission(parsed) : parsed;
                        
                        // Ensure structure
                        if(!activeMission.driverNotes) activeMission.driverNotes = '';
                        localStorage.setItem('kenekozo_mission', JSON.stringify(activeMission));
                        switchRole('driver');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { console.error("Link invalid", e); }
            } else { loadMissionFromStorage(); }
            lucide.createIcons();
            const savedPhone = localStorage.getItem('kenekozo_phone');
            if(savedPhone) document.getElementById('admin-phone').value = savedPhone;
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2000);
        }

        function initAdminMap() {
            if (map) return; 
            if (!document.getElementById('map')) return; 
            map = L.map('map').setView([WAREHOUSE.lat, WAREHOUSE.lng], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([WAREHOUSE.lat, WAREHOUSE.lng]).addTo(map).bindPopup("Gudang Kenekozo");
            
            map.on('click', function(e) {
                if (currentRole !== 'admin') return;
                
                const latLngStr = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
                
                // JIKA MODAL EDIT TERBUKA, UPDATE INPUT EDIT
                if (!document.getElementById('edit-modal').classList.contains('hidden')) {
                     document.getElementById('edit-latlng').value = latLngStr;
                     if(editMarker) map.removeLayer(editMarker);
                     editMarker = L.marker(e.latlng, {draggable:true}).addTo(map);
                     return;
                }

                // Default behavior (Manual Add)
                if (selectedCoords) map.removeLayer(selectedCoords);
                selectedCoords = L.marker(e.latlng, {draggable: true}).addTo(map);
                document.getElementById('cust-coord').value = latLngStr;
            });
        }

        function initDriverMap() {
            if(driverMap) return; 
            if (!document.getElementById('driver-map')) return; 
            driverMap = L.map('driver-map').setView([WAREHOUSE.lat, WAREHOUSE.lng], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(driverMap);
        }

        function parseBulkInput() {
            const text = document.getElementById('bulk-input').value;
            if(!text.trim()) return alert("Tempel teks dulu!");
            adminMarkers.forEach(m => map.removeLayer(m));
            adminMarkers = [];
            stops = []; 
            if (text.includes('PESANAN SEWA') || text.includes('DATA PENYEWA')) parseReceiptFormat(text);
            else parseLegacyListFormat(text);
            if(stops.length === 0) alert("Gagal baca data. Cek format!");
            else {
                renderDraftList();
                document.getElementById('bulk-input').value = ''; 
                
                // Add Markers
                const validStops = stops.filter(s => s.lat !== 0);
                validStops.forEach(s => {
                    const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(s.name);
                    adminMarkers.push(m);
                });
                
                // Fit bounds
                if(validStops.length > 0) {
                    const bounds = L.latLngBounds(validStops.map(s => [s.lat, s.lng]));
                    bounds.extend([WAREHOUSE.lat, WAREHOUSE.lng]);
                    map.fitBounds(bounds, {padding: [50,50]});
                }
            }
        }

        // ... (Parsing functions remain same) ...
        function parseReceiptFormat(text) {
            const blocks = text.split(/(?=PESANAN SEWA|DATA PENYEWA)/gi).filter(t => t.trim().length > 10);
            if (blocks.length === 0) parseSingleReceipt(text); 
            else blocks.forEach(block => parseSingleReceipt(block));
        }

        function parseSingleReceipt(text) {
            const nameMatch = text.match(/Nama:\s*(.+)/);
            const waMatch = text.match(/WA:\s*(.+)/);
            const addrMatch = text.match(/ALAMAT PENGIRIMAN\s*\n\s*(.+?)\s*(\(Maps|$)/i); 
            const mapsMatch = text.match(/maps\.google\.com\/\?q=([-0-9\.]+),([-0-9\.]+)/);
            let items = []; let totalLoadFee = 0;
            const lines = text.split('\n'); let capturingUnits = false;
            lines.forEach(line => {
                if (line.includes('UNIT YANG DIPESAN')) { capturingUnits = true; return; }
                if (line.includes('RINCIAN BIAYA')) { capturingUnits = false; return; }
                if (capturingUnits) {
                    const itemMatch = line.match(/^\s*\d+\.\s*(.+?)(\(|$)/); 
                    if (itemMatch) {
                        const itemName = itemMatch[1].trim();
                        const fee = calculateUnitFee(itemName);
                        items.push({ name: itemName, fee: fee });
                        totalLoadFee += fee;
                    }
                }
            });
            if (nameMatch) {
                const lat = mapsMatch ? parseFloat(mapsMatch[1]) : 0;
                const lng = mapsMatch ? parseFloat(mapsMatch[2]) : 0;
                const addr = addrMatch ? addrMatch[1].trim() : (mapsMatch ? 'Alamat sesuai Maps' : '‚ö†Ô∏è ALAMAT/MAPS TIDAK TERDETEKSI');
                stops.push({
                    id: Date.now() + Math.random(), task: 'DELIVERY', name: nameMatch[1].trim(),
                    phone: waMatch ? waMatch[1].trim() : '-', address: addr, lat: lat, lng: lng,
                    status: 'PENDING', size: 'custom', items: items, customLoadFee: totalLoadFee 
                });
            }
        }

        function parseLegacyListFormat(text) {
            const lines = text.split('\n');
            let currentTask = 'DELIVERY'; let currentItem = {}; let isParsingItem = false;
            const pushCurrentItem = () => {
                if (isParsingItem && currentItem.name) {
                    if (!currentItem.lat) { currentItem.lat = 0; currentItem.lng = 0; currentItem.address = "‚ö†Ô∏è CEK LOKASI (Maps tidak terbaca)"; }
                    stops.push(currentItem);
                }
            };
            lines.forEach(line => {
                const cleanLine = line.trim();
                if (cleanLine.match(/(üì¶|:package:)?\s*PENGIRIMAN/i)) currentTask = 'DELIVERY';
                if (cleanLine.match(/(üöö|:truck:)?\s*PENJEMPUTAN/i)) currentTask = 'PICKUP';
                const nameMatch = cleanLine.match(/^\d+[\.\)]?\s*(.+?)(?:\(|$|[\n\r])/);
                if (nameMatch) {
                    pushCurrentItem();
                    isParsingItem = true;
                    const phoneMatch = cleanLine.match(/\((08\d+)\)/);
                    currentItem = {
                        id: Date.now() + Math.random(), task: currentTask, name: nameMatch[1].trim(),
                        phone: phoneMatch ? phoneMatch[1] : '-', address: 'Sesuai Titik Maps',
                        status: 'PENDING', size: 'small', customLoadFee: 0, items: []
                    };
                }
                if (isParsingItem) {
                    const unitMatch = cleanLine.match(/(üßä|:ice:)?\s*Unit:\s*(.+)/i);
                    if (unitMatch) {
                        const unitName = unitMatch[2]; const fee = calculateUnitFee(unitName);
                        currentItem.items = [{name: unitName, fee: fee}]; currentItem.customLoadFee = fee;
                    }
                    const locMatch = cleanLine.match(/Lok:\s*(.+)/i);
                    if (locMatch) {
                        // Check if loc contains a URL, if so clean it
                        let addr = locMatch[1].trim();
                        if(addr.includes('http')) {
                            // Split by http and take the first part or just say "Lihat di Peta"
                            const parts = addr.split('http');
                            addr = parts[0].trim() || 'Lihat di Peta üó∫Ô∏è';
                        }
                        currentItem.address = addr;
                    }
                    
                    const mapsMatch = cleanLine.match(/maps\.google\.com\/\?q=([-0-9\.]+),([-0-9\.]+)/);
                    if (mapsMatch) { currentItem.lat = parseFloat(mapsMatch[1]); currentItem.lng = parseFloat(mapsMatch[2]); }
                }
            });
            pushCurrentItem();
        }

        function calculateUnitFee(itemName) {
            const s = itemName.toLowerCase();
            if (s.includes('500') || s.includes('600') || s.includes('700') || s.includes('750') || s.includes('jumbo')) return 25000;
            if (s.includes('6 rak') || s.includes('230') || s.includes('280') || s.includes('300') || s.includes('400') || s.includes('sliding') || s.includes('256')) return 15000;
            return 10000; 
        }

        // --- EDIT FUNCTIONS ---
        function renderDraftList() {
            const list = document.getElementById('stops-ul');
            const container = document.getElementById('draft-list');
            if (stops.length > 0) {
                container.classList.remove('hidden');
                list.innerHTML = stops.map((s, idx) => {
                    const isError = s.lat === 0 && s.lng === 0;
                    const bgClass = isError ? 'bg-red-50 border-red-200' : 'border-b';
                    const textClass = isError ? 'text-red-600' : 'text-gray-500';
                    const errBadge = isError ? '<span class="bg-red-500 text-white text-[10px] px-1 rounded ml-2">DATA TIDAK LENGKAP</span>' : '';

                    return `
                    <li class="${bgClass} pb-2 p-1 rounded relative group hover:bg-gray-50">
                        <div class="flex justify-between font-bold text-gray-800">
                            <span>${idx+1}. ${s.name} ${errBadge}</span>
                            <div class="flex gap-1">
                                <span class="text-xs bg-gray-100 px-2 rounded self-center">Rp ${s.customLoadFee/1000}k</span>
                                <button onclick="openEditStop(${idx})" class="text-blue-500 hover:text-blue-700 p-1 bg-white border rounded shadow-sm" title="Edit Data"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                <button onclick="removeStop(${idx})" class="text-red-500 hover:text-red-700 p-1 bg-white border rounded shadow-sm" title="Hapus"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <div class="text-xs ${textClass} truncate pr-16">${s.address}</div>
                        ${isError ? `<div class="text-[10px] text-red-500 mt-1">‚ö†Ô∏è Lokasi Maps belum ada. Klik tombol pensil untuk tambah titik peta.</div>` : ''}
                    </li>
                `}).join('');
                lucide.createIcons();
            } else { container.classList.add('hidden'); }
        }

        function openEditStop(idx) {
            const s = stops[idx];
            document.getElementById('edit-index').value = idx;
            document.getElementById('edit-name').value = s.name;
            document.getElementById('edit-address').value = s.address;
            document.getElementById('edit-fee').value = s.customLoadFee;
            
            const latStr = s.lat === 0 ? '' : s.lat;
            const lngStr = s.lng === 0 ? '' : s.lng;
            document.getElementById('edit-latlng').value = latStr && lngStr ? `${latStr}, ${lngStr}` : '';
            
            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
            
            // Set marker on map if valid
            if(s.lat !== 0) {
                if(editMarker) map.removeLayer(editMarker);
                editMarker = L.marker([s.lat, s.lng], {draggable:true}).addTo(map);
                map.setView([s.lat, s.lng], 15);
            } else {
                if(editMarker) map.removeLayer(editMarker);
                map.setView([WAREHOUSE.lat, WAREHOUSE.lng], 10);
            }
        }

        function saveEditStop() {
            const idx = document.getElementById('edit-index').value;
            const name = document.getElementById('edit-name').value;
            const addr = document.getElementById('edit-address').value;
            const fee = parseInt(document.getElementById('edit-fee').value) || 0;
            const latLngStr = document.getElementById('edit-latlng').value;

            if(!latLngStr.includes(',')) return alert("Koordinat belum dipilih! Klik peta dulu.");
            
            const [lat, lng] = latLngStr.split(',').map(parseFloat);

            stops[idx].name = name;
            stops[idx].address = addr;
            stops[idx].customLoadFee = fee;
            stops[idx].lat = lat;
            stops[idx].lng = lng;

            closeEditModal();
            
            // Refresh Markers & List
            adminMarkers.forEach(m => map.removeLayer(m));
            adminMarkers = [];
            const validStops = stops.filter(s => s.lat !== 0);
            validStops.forEach(s => {
                const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(s.name);
                adminMarkers.push(m);
            });
            renderDraftList();
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            if(editMarker) map.removeLayer(editMarker);
            editMarker = null;
        }

        function removeStop(idx) {
            if(confirm("Hapus data ini?")) {
                stops.splice(idx, 1);
                renderDraftList();
                // Refresh map
                adminMarkers.forEach(m => map.removeLayer(m));
                adminMarkers = [];
                stops.forEach(s => {
                    if(s.lat !== 0) {
                        const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(s.name);
                        adminMarkers.push(m);
                    }
                });
            }
        }

        // --- NEW: Minification Logic to reduce URL size ---
        function minifyMission(m) {
            return {
                v: 2, // version
                id: m.id, dt: m.date, ap: m.adminPhone, km: m.totalDistance,
                s: m.stops.map(s => ({
                    n: s.name, t: s.task==='DELIVERY'?'D':'P', hp: s.phone,
                    al: s.address, la: s.lat, ln: s.lng,
                    st: s.status, sz: s.size, cf: s.customLoadFee,
                    it: s.items.map(i => ({n: i.name, f: i.fee}))
                })),
                py: { dr: m.payment.drive, ld: m.payment.load, ml: m.payment.meal, tt: m.payment.total },
                nt: m.driverNotes || ''
            };
        }

        function expandMission(m) {
            return {
                id: m.id, date: m.dt, adminPhone: m.ap, totalDistance: m.km,
                stops: m.s.map(s => ({
                    name: s.n, task: s.t==='D'?'DELIVERY':'PICKUP', phone: s.hp,
                    address: s.al, lat: s.la, lng: s.ln,
                    status: s.st, size: s.sz, customLoadFee: s.cf,
                    items: s.it.map(i => ({name: i.n, fee: i.f}))
                })),
                payment: { drive: m.py.dr, load: m.py.ld, meal: m.py.ml, total: m.py.tt },
                driverNotes: m.nt || '',
                // Preserve optional properties if expanding back from storage
                startTime: m.t1, endTime: m.t2, startTimeTs: m.ts1, endTimeTs: m.ts2
            };
        }

        // --- NEW OPTIMIZED ROUTING (BRUTE FORCE TSP FOR SMALL N) ---
        function optimizeRoute(start, points) {
            if (points.length <= 5) {
                // Brute force permutations to find TRUE shortest path
                let bestOrder = points;
                let minDist = Infinity;
                
                const permutations = permute(points);
                permutations.forEach(order => {
                    let d = 0;
                    let curr = start;
                    order.forEach(p => {
                        d += calcDist(curr, p);
                        curr = p;
                    });
                    d += calcDist(curr, start); // Return to base
                    
                    if (d < minDist) {
                        minDist = d;
                        bestOrder = order;
                    }
                });
                return bestOrder;
            } else {
                // Greedy Nearest Neighbor (Faster for many points)
                let sorted = [];
                let curr = start;
                let pool = [...points];
                while(pool.length > 0) {
                    let nearestIdx = -1;
                    let nearestDist = Infinity;
                    pool.forEach((p, i) => {
                        const d = calcDist(curr, p);
                        if (d < nearestDist) { nearestDist = d; nearestIdx = i; }
                    });
                    curr = pool[nearestIdx];
                    sorted.push(curr);
                    pool.splice(nearestIdx, 1);
                }
                return sorted;
            }
        }

        function calcDist(p1, p2) {
            return Math.sqrt(Math.pow(p1.lat - p2.lat, 2) + Math.pow(p1.lng - p2.lng, 2));
        }

        function permute(permutation) {
            var length = permutation.length,
                result = [permutation.slice()],
                c = new Array(length).fill(0),
                i = 1, k, p;
            while (i < length) {
                if (c[i] < i) {
                    k = i % 2 && c[i];
                    p = permutation[i];
                    permutation[i] = permutation[k];
                    permutation[k] = p;
                    ++c[i];
                    i = 1;
                    result.push(permutation.slice());
                } else {
                    c[i] = 0;
                    ++i;
                }
            }
            return result;
        }

        async function generateMission() {
            if (stops.length === 0) return;
            
            // Check for invalid stops
            if (stops.some(s => s.lat === 0 && s.lng === 0)) {
                if(!confirm("‚ö†Ô∏è PERINGATAN: Ada data yang lokasi Maps-nya tidak terbaca (ditandai merah). Jika dilanjutkan, rute mungkin error. Lanjut?")) return;
            }

            const adminPhone = document.getElementById('admin-phone').value;
            localStorage.setItem('kenekozo_phone', adminPhone);
            
            let validStops = stops.filter(s => s.lat !== 0);
            let invalidStops = stops.filter(s => s.lat === 0);
            
            // USE NEW OPTIMIZER
            let sortedStops = optimizeRoute(WAREHOUSE, validStops);
            
            // Re-add invalid stops at the end so they are not lost
            sortedStops = [...sortedStops, ...invalidStops];

            const routePoints = [WAREHOUSE, ...validStops, WAREHOUSE]; // Only route valid points
            const coordsString = routePoints.map(p => `${p.lng},${p.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/driving/${coordsString}?overview=full&geometries=geojson`;
            
            const btn = document.querySelector('#draft-list button');
            const oriText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Proses...'; btn.disabled = true;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Fallback distance calculation if routing fails (or just 1 invalid stop)
                let totalKM = 0;
                if(data.routes && data.routes[0]) {
                     totalKM = Math.ceil((data.routes[0].distance / 1000) * 1.05);
                } else {
                     totalKM = 10; // Default fallback
                     alert("Gagal hitung rute otomatis (Mungkin karena data lokasi error). Jarak diset manual ke 10km.");
                }

                let payLoad = 0;
                sortedStops.forEach(s => { if (s.customLoadFee) payLoad += s.customLoadFee; else payLoad += PRICES.load[s.size]; });
                const payDrive = totalKM * PRICES.perKM; const payMeal = PRICES.meal;
                const missionObj = {
                    id: 'M-' + Date.now(),
                    date: new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                    adminPhone: adminPhone, totalDistance: totalKM, stops: sortedStops, 
                    startTime: null, endTime: null, startTimeTs: null, endTimeTs: null,
                    driverNotes: '',
                    payment: { drive: payDrive, load: payLoad, meal: payMeal, total: payDrive + payLoad + payMeal }
                };
                
                // USE MINIFIED OBJECT FOR LINK GENERATION
                const minifiedObj = minifyMission(missionObj);
                const jsonString = JSON.stringify(minifiedObj);
                const compressed = LZString.compressToEncodedURIComponent(jsonString);
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?d=${compressed}`;
                document.getElementById('share-link-input').value = shareUrl;
                document.getElementById('manual-code-area').value = compressed;
                const waText = `*MISI KENEKOZO BARU* üöö\nTanggal: ${missionObj.date}\nTotal Stop: ${missionObj.stops.length}\nJarak: ${missionObj.totalDistance} KM\n\n*Kode Load Manual:*\n${compressed}`;
                document.getElementById('wa-share-btn').href = `https://wa.me/?text=${encodeURIComponent(waText)}`;
                
                document.getElementById('share-section').classList.remove('hidden');
                
                // Save full object to storage for local testing
                localStorage.setItem('kenekozo_mission', JSON.stringify(missionObj));
                activeMission = missionObj;
                stops = []; adminMarkers.forEach(m => map.removeLayer(m)); adminMarkers = [];
                renderDraftList(); document.getElementById('bulk-input').value = '';
            } catch (e) { console.error(e); alert("Gagal hitung rute/koneksi. Cek internet atau data lokasi."); }
            btn.innerHTML = oriText; btn.disabled = false;
        }

        async function tryShortenLink() {
            if (window.location.protocol === 'file:') {
                document.getElementById('shorten-warning').classList.remove('hidden');
                return;
            }
            const longUrl = document.getElementById('share-link-input').value;
            const btn = document.querySelector('#share-section button');
            const oriText = btn.innerHTML;
            btn.innerText = '‚è≥ Memendekkan...'; btn.disabled = true;
            try {
                const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
                if(res.ok) {
                    const shortUrl = await res.text();
                    document.getElementById('share-link-input').value = shortUrl;
                    const baseMsg = document.getElementById('wa-share-btn').href;
                    // Try to replace the long code in WA msg if possible, but easier to just append
                    const waText = `*MISI KENEKOZO BARU* üöö\nLink: ${shortUrl}`;
                    document.getElementById('wa-share-btn').href = `https://wa.me/?text=${encodeURIComponent(waText)}`;
                    alert("Link berhasil dipendekkan!");
                } else { throw new Error('API Error'); }
            } catch(e) { alert("Gagal memendekkan link. Pastikan online."); }
            btn.innerHTML = oriText; btn.disabled = false;
        }

        function addStopManual() {
            const name = document.getElementById('cust-name').value;
            const size = document.getElementById('cust-size').value;
            const coordStr = document.getElementById('cust-coord').value;
            if(!name || !coordStr) return alert("Lengkapi data!");
            const [lat, lng] = coordStr.split(',').map(parseFloat);
            let fee = 10000; if (size === 'medium') fee = 15000; if (size === 'large') fee = 25000;
            stops.push({
                id: Date.now(), task: 'DELIVERY', name: name, size: size, lat: lat, lng: lng,
                status: 'PENDING', customLoadFee: fee, items: [{name: 'Manual Input', fee: fee}]
            });
            const m = L.marker([lat, lng]).addTo(map).bindPopup(name); adminMarkers.push(m); renderDraftList();
        }

        function renderDriverView() {
            if (!activeMission) return;
            document.getElementById('no-mission').classList.add('hidden');
            document.getElementById('active-mission-card').classList.remove('hidden');

            document.getElementById('m-date').innerText = activeMission.date;
            document.getElementById('m-dist').innerText = activeMission.totalDistance;
            document.getElementById('m-total-pay').innerText = 'Rp ' + activeMission.payment.total.toLocaleString('id-ID');
            document.getElementById('pay-drive').innerText = 'Rp ' + activeMission.payment.drive.toLocaleString('id-ID');
            document.getElementById('pay-load').innerText = 'Rp ' + activeMission.payment.load.toLocaleString('id-ID');

            const status = activeMission.status || 'PENDING';
            if (activeMission.startTime) {
                document.getElementById('m-start-time').innerText = `üöÄ Mulai: ${activeMission.startTime}`;
                document.getElementById('m-start-time').classList.remove('hidden');
            }
            if (activeMission.endTime) {
                document.getElementById('m-end-time').innerText = `üèÅ Selesai: ${activeMission.endTime}`;
                document.getElementById('m-end-time').classList.remove('hidden');
            }

            const actionBtns = document.getElementById('action-buttons');
            const garageBtn = document.getElementById('finish-garage-btn');
            const finishForm = document.getElementById('finish-form');
            const badge = document.getElementById('m-status-badge');
            
            badge.innerText = status === 'ACCEPTED' ? 'SEDANG JALAN' : status;
            
            actionBtns.classList.add('hidden');
            garageBtn.classList.add('hidden');
            finishForm.classList.add('hidden');

            if (status === 'PENDING') {
                actionBtns.classList.remove('hidden');
            } else if (status === 'ACCEPTED') {
                const allDone = activeMission.stops.every(s => s.status === 'DONE');
                if(allDone) {
                    garageBtn.classList.remove('hidden');
                }
            } else if (status === 'COMPLETED') {
                finishForm.classList.remove('hidden');
                document.getElementById('finish-time-display').innerText = activeMission.endTime || '-';
                // Pre-fill notes if existing
                document.getElementById('driver-notes').value = activeMission.driverNotes || '';
                
                // Show Duration
                if (activeMission.startTimeTs && activeMission.endTimeTs) {
                    const diff = activeMission.endTimeTs - activeMission.startTimeTs;
                    const hrs = Math.floor(diff / 3600000);
                    const mins = Math.floor((diff % 3600000) / 60000);
                    document.getElementById('total-duration-display').innerText = `‚è±Ô∏è Durasi: ${hrs} Jam ${mins} Menit`;
                }
            }

            setTimeout(async () => {
                initDriverMap(); driverMap.invalidateSize();
                driverMap.eachLayer((l) => { if (l instanceof L.Marker || l instanceof L.Polyline) driverMap.removeLayer(l); });
                L.marker([WAREHOUSE.lat, WAREHOUSE.lng]).addTo(driverMap);
                const bounds = new L.LatLngBounds(); bounds.extend([WAREHOUSE.lat, WAREHOUSE.lng]);
                activeMission.stops.forEach((s, idx) => {
                    if(s.lat === 0 && s.lng === 0) return; // Skip invalid markers on map
                    const color = s.task === 'DELIVERY' ? 'blue' : 'red';
                    const markerHtml = `<div style="background:${color}; width:16px; height:16px; border-radius:50%; border:2px solid white; color:white; font-size:10px; font-weight:bold; display:flex; justify-content:center; align-items:center;">${idx+1}</div>`;
                    L.marker([s.lat, s.lng], {icon: L.divIcon({html: markerHtml, className:''})}).addTo(driverMap).bindPopup(s.name);
                    bounds.extend([s.lat, s.lng]);
                });
                const pts = [WAREHOUSE, ...activeMission.stops.filter(s=>s.lat!==0), WAREHOUSE];
                if(pts.length > 2) {
                    const coords = pts.map(p => `${p.lng},${p.lat}`).join(';');
                    try {
                        const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
                        const d = await res.json();
                        L.geoJSON(d.routes[0].geometry, { style: { color: '#3b82f6', weight: 4, opacity: 0.7 } }).addTo(driverMap);
                    } catch(e){}
                }
                driverMap.fitBounds(bounds, {padding:[30,30]});
            }, 500);

            const list = document.getElementById('driver-stops-list');
            list.innerHTML = activeMission.stops.map((s, idx) => {
                const isDone = s.status === 'DONE'; const isAccepted = status === 'ACCEPTED';
                const itemsHtml = s.items.map(i => `<div class="font-bold text-indigo-900">‚Ä¢ ${i.name}</div>`).join('');
                const rawPhone = s.phone.replace(/[^0-9]/g, '');
                let formattedPhone = rawPhone; if(rawPhone.startsWith('08')) formattedPhone = '62'+rawPhone.substring(1); else if(rawPhone.startsWith('8')) formattedPhone = '62'+rawPhone;
                const taskType = s.task === 'DELIVERY' ? 'PENGANTARAN' : 'PENJEMPUTAN';
                const unitListStr = s.items.map(i => i.name).join(', ');
                const waMessage = `Halo kak ${s.name}, saya Panggih dari Kenekozo Freezer ‚ùÑÔ∏è.\n\nMau info untuk *${taskType}* unit:\n*${unitListStr}*\nke alamat kakak.\n\nApakah ada orang di lokasi? Terima kasih üôè`;
                const waLink = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(waMessage)}`;
                
                // Handle invalid Maps
                const isMapError = s.lat === 0;
                const mapLink = isMapError ? '#' : `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}`;
                const mapStyle = isMapError ? 'bg-gray-200 text-gray-400 pointer-events-none' : 'text-blue-600 bg-blue-50 hover:bg-blue-100';

                return `<div class="bg-white border rounded-lg p-3 relative ${isDone ? 'opacity-50 bg-gray-50' : 'shadow-sm'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 pr-14">
                            <div class="flex items-center gap-1 mb-1">
                                <span class="bg-gray-800 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold">${idx + 1}</span>
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded ${s.task === 'DELIVERY' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'}">${s.task==='DELIVERY'?'KIRIM':'AMBIL'}</span>
                                <span class="font-bold text-sm ${isDone ? 'line-through' : ''}">${s.name}</span>
                            </div>
                            <div class="text-xs text-gray-500 mb-2 pl-6">
                                <p class="line-clamp-2">üìç ${s.address}</p>
                                ${isMapError ? '<p class="text-[10px] text-red-500 font-bold mt-1">‚ö†Ô∏è Koordinat Error (Cek Manual)</p>' : ''}
                                <div class="flex items-center gap-2 mt-1">
                                    <span>üìû ${s.phone}</span>
                                    <a href="${waLink}" target="_blank" class="text-green-600 bg-green-50 px-1 rounded hover:bg-green-100 font-bold border border-green-200">Chat</a>
                                </div>
                            </div>
                            <div class="pl-6 mt-1">
                                <div class="text-xs border-l-2 border-indigo-200 pl-2 py-1 mb-1 bg-indigo-50 rounded-r">
                                    ${itemsHtml}
                                    <div class="text-[10px] text-gray-500 mt-1">(Otot: Rp ${s.customLoadFee.toLocaleString('id-ID')})</div>
                                </div>
                                <a href="${mapLink}" target="_blank" class="inline-flex items-center gap-1 font-bold text-xs px-2 py-1 rounded mt-1 ${mapStyle}"><i data-lucide="navigation" class="w-3 h-3"></i> Maps</a>
                            </div>
                        </div>
                        ${isAccepted && !isDone ? `
                        <div class="absolute right-3 top-3 flex flex-col gap-1 items-end">
                            <button onclick="markStopDone(${idx})" class="bg-green-600 text-white px-3 py-2 rounded-lg shadow-sm flex items-center gap-1 text-xs font-bold hover:bg-green-700" title="Tandai Selesai (Tanpa WA)"><i data-lucide="check" class="w-4 h-4"></i> Selesai</button>
                            <button onclick="reportViaWA(${idx})" class="bg-white border border-green-600 text-green-600 px-2 py-1 rounded-lg shadow-sm flex items-center gap-1 text-[10px] font-bold hover:bg-green-50" title="Lapor via WA (Opsional)">WA</button>
                        </div>` : (isDone ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-green-500 absolute right-3 top-3"></i>' : '')}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- NEW: Save Driver Notes ---
        function saveDriverNotes() {
            const note = document.getElementById('driver-notes').value;
            if(activeMission) {
                activeMission.driverNotes = note;
                localStorage.setItem('kenekozo_mission', JSON.stringify(activeMission));
            }
        }

        // --- NEW: Send Finish WA ---
        function sendFinishWA() {
            if(!activeMission) return;
            const note = activeMission.driverNotes ? `\n\nüìù *Catatan Sopir:*\n${activeMission.driverNotes}` : '';
            const msg = `Alhamdulillah, sudah sampai garasi Bu! üèÅ\nüïí ${activeMission.endTime}${note}\n\nMisi selesai.`;
            window.open(`https://wa.me/${activeMission.adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- UPDATED PDF REPORT (For Driver/General) ---
        function downloadPDFReport() {
            if (!activeMission) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            // ... (Kode PDF Report Driver tetap sama)
            doc.setFillColor(79, 70, 229); // Indigo
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text("KENEKOZO LOGISTICS REPORT", 10, 13);
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Tanggal: ${activeMission.date}`, 10, 30);
            doc.text(`Mulai: ${activeMission.startTime || '-'}`, 10, 35);
            doc.text(`Selesai: ${activeMission.endTime || '-'}`, 10, 40);
            let durationStr = '-';
            if (activeMission.startTimeTs && activeMission.endTimeTs) {
                const diff = activeMission.endTimeTs - activeMission.startTimeTs;
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                durationStr = `${hrs} Jam ${mins} Menit`;
            }
            doc.text(`Durasi: ${durationStr}`, 10, 45);
            doc.text(`Jarak: ${activeMission.totalDistance} KM`, 10, 50);
            const tableBody = activeMission.stops.map((s, i) => [
                i+1, s.name, s.task==='DELIVERY'?'Kirim':'Ambil', s.items.map(x=>x.name).join('\n'), `Rp ${s.customLoadFee.toLocaleString('id-ID')}`, s.finishTime||'Selesai'
            ]);
            doc.autoTable({ startY: 55, head: [['No', 'Customer', 'Tipe', 'Unit', 'Ongkos', 'Jam']], body: tableBody, theme: 'grid', headStyles: { fillColor: [79, 70, 229] }, styles: { fontSize: 8, cellPadding: 2 } });
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Terima: Rp ${activeMission.payment.total.toLocaleString('id-ID')}`, 15, finalY);
            if(activeMission.driverNotes) {
                finalY += 10;
                doc.text(`Catatan Sopir: ${activeMission.driverNotes}`, 15, finalY);
            }
            doc.save(`Laporan_Driver_${Date.now()}.pdf`);
        }

        function updateMissionStatus(st) {
            if(st === 'REJECTED' && !confirm('Hapus misi?')) return;
            if(st === 'REJECTED') { localStorage.removeItem('kenekozo_mission'); location.reload(); return; }
            
            const now = new Date();
            const timeStr = `${now.toLocaleDateString('id-ID', {day:'numeric', month:'short'})}, ${now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}`;

            if(st === 'ACCEPTED' && !activeMission.startTime) {
                activeMission.startTime = timeStr;
                activeMission.startTimeTs = now.getTime(); // Store TS
                if(confirm("Buka WA untuk lapor 'Mulai Jalan' ke Admin?")) {
                    const url = `https://wa.me/${activeMission.adminPhone}?text=${encodeURIComponent(`Bismillah, saya jalan ya Bu! üöõüí®\nüïí ${activeMission.startTime}\n\n*Saya juga sudah share Live Location.*`)}`;
                    window.open(url, '_blank');
                } else {
                    showToast("Status: MULAI JALAN (Tersimpan)");
                }
            }
            
            if(st === 'COMPLETED' && !activeMission.endTime) {
                activeMission.endTime = timeStr;
                activeMission.endTimeTs = now.getTime(); // Store TS
                // Notice: We don't send WA immediately here, we let them fill notes first then click "Lapor via WA"
            }

            activeMission.status = st;
            localStorage.setItem('kenekozo_mission', JSON.stringify(activeMission));
            renderDriverView();
        }
        function markStopDone(idx) {
            // New "Silent" mode
            if(!confirm('Tandai selesai? (Tanpa buka WA)')) return;
            activeMission.stops[idx].status = 'DONE';
            activeMission.stops[idx].finishTime = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            localStorage.setItem('kenekozo_mission', JSON.stringify(activeMission));
            showToast("‚úÖ Tugas Selesai Disimpan");
            renderDriverView();
        }
        function reportViaWA(idx) {
            const s = activeMission.stops[idx];
            const now = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            const units = s.items.map(i => i.name).join(', ');
            const msg = `Lapor Bu! ü´°\n‚úÖ ${s.name}\nüìã ${units}\nüïí ${now}\nFoto bukti üëá`;
            window.open(`https://wa.me/${activeMission.adminPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
        function switchRole(r) {
            currentRole = r;
            document.getElementById('view-admin').className = r === 'admin' ? '' : 'hidden';
            document.getElementById('view-driver').className = r === 'driver' ? '' : 'hidden';
            document.getElementById('btn-admin').className = r === 'admin' ? "px-3 py-1 rounded-md text-sm font-medium bg-white text-indigo-900 shadow" : "px-3 py-1 rounded-md text-sm font-medium text-gray-300 hover:text-white";
            document.getElementById('btn-driver').className = r === 'driver' ? "px-3 py-1 rounded-md text-sm font-medium bg-white text-indigo-900 shadow" : "px-3 py-1 rounded-md text-sm font-medium text-gray-300 hover:text-white";
            if(r==='driver') loadMissionFromStorage();
            else setTimeout(() => map.invalidateSize(), 100);
        }
        function copyShareLink() {
            const el = document.getElementById("share-link-input");
            el.select(); document.execCommand('copy'); alert("Link disalin!");
        }
        function copyManualCode() {
            const el = document.getElementById("manual-code-area");
            el.select(); document.execCommand('copy'); alert("Kode manual disalin!");
        }
        function loadManualCode() {
            const code = document.getElementById("driver-paste-area").value;
            if(!code) return;
            try {
                const jsonStr = LZString.decompressFromEncodedURIComponent(code);
                if(jsonStr) {
                    const parsed = JSON.parse(jsonStr);
                    activeMission = parsed.v === 2 ? expandMission(parsed) : parsed;
                    if(!activeMission.driverNotes) activeMission.driverNotes = '';
                    localStorage.setItem('kenekozo_mission', JSON.stringify(activeMission));
                    renderDriverView();
                } else { alert("Kode salah!"); }
            } catch(e) { alert("Format kode invalid!"); }
        }
        function resetAll() { if(confirm('Reset?')) { localStorage.removeItem('kenekozo_mission'); location.reload(); } }
        function toggleTariffInfo() { document.getElementById('tariff-modal').classList.toggle('hidden'); }
        function loadMissionFromStorage() {
            const data = localStorage.getItem('kenekozo_mission');
            if(data) { 
                const parsed = JSON.parse(data);
                activeMission = parsed.v === 2 ? expandMission(parsed) : parsed;
                renderDriverView(); 
            }
        }

        // --- NEW: Salary Slip Functions ---
        function openSalaryModal() {
            if(!activeMission) return alert("Belum ada data misi!");
            document.getElementById('salary-modal').classList.remove('hidden');
            
            // Fill initial data
            document.getElementById('slip-drive').value = activeMission.payment.drive;
            document.getElementById('slip-load').value = activeMission.payment.load;
            document.getElementById('slip-meal').value = activeMission.payment.meal;
            document.getElementById('slip-adj-desc').value = '';
            document.getElementById('slip-adj-val').value = '';
            document.getElementById('slip-note').value = '';
            
            calculateSalaryTotal();
        }

        function closeSalaryModal() {
            document.getElementById('salary-modal').classList.add('hidden');
        }

        function calculateSalaryTotal() {
            const d = parseInt(document.getElementById('slip-drive').value) || 0;
            const l = parseInt(document.getElementById('slip-load').value) || 0;
            const m = parseInt(document.getElementById('slip-meal').value) || 0;
            const a = parseInt(document.getElementById('slip-adj-val').value) || 0;
            
            const total = d + l + m + a;
            document.getElementById('slip-total-display').innerText = 'Rp ' + total.toLocaleString('id-ID');
            return total;
        }

        function printSalarySlip() {
            const { jsPDF } = window.jspdf;
            // Gunakan format roll 80mm, tinggi menyesuaikan konten (estimasi awal 250mm, nanti auto cut kalo printer support, tapi di PDF static)
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: [80, 250] 
            });

            const d = parseInt(document.getElementById('slip-drive').value) || 0;
            const l = parseInt(document.getElementById('slip-load').value) || 0;
            const m = parseInt(document.getElementById('slip-meal').value) || 0;
            const aVal = parseInt(document.getElementById('slip-adj-val').value) || 0;
            const aDesc = document.getElementById('slip-adj-desc').value || 'Penyesuaian';
            const note = document.getElementById('slip-note').value;
            const total = d + l + m + aVal;

            // --- HEADER ---
            doc.setFillColor(55, 48, 163); // Indigo 800
            doc.rect(0, 0, 80, 25, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text("KENEKOZO LOGISTICS", 40, 10, {align:'center'});
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text("Slip Gaji & Operasional Driver", 40, 15, {align:'center'});
            doc.text(activeMission.date, 40, 20, {align:'center'});

            doc.setTextColor(0, 0, 0);
            let y = 32;

            // --- RINCIAN MISI ---
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text("RINGKASAN MISI:", 5, y);
            y += 5;
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Jarak Tempuh: ${activeMission.totalDistance} KM`, 5, y);
            y += 5;

            // Tabel Stops
            const stopsBody = activeMission.stops.map(s => [
                s.name.substring(0, 15), // Truncate name if too long
                s.items.map(i => i.name).join(', ') // Units
            ]);

            doc.autoTable({
                startY: y,
                head: [['Customer', 'Unit']],
                body: stopsBody,
                theme: 'plain',
                styles: { fontSize: 7, cellPadding: 1 },
                headStyles: { fillColor: [240, 240, 240], textColor: [0,0,0], fontStyle: 'bold' },
                columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 40 } },
                margin: { left: 5, right: 5 }
            });

            y = doc.lastAutoTable.finalY + 8;

            // --- RINCIAN GAJI ---
            // Draw Box
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.1);
            doc.line(5, y, 75, y); // Separator
            y += 5;

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text("RINCIAN PEMBAYARAN:", 5, y);
            y += 6;

            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');

            // Helper for Row
            const addRow = (label, val, isBold = false) => {
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                doc.text(label, 5, y);
                doc.text(val, 75, y, {align:'right'});
                y += 5;
            };

            addRow("Uang Jalan (BBM+Jasa)", `Rp ${d.toLocaleString('id-ID')}`);
            addRow("Ongkos Otot (Muatan)", `Rp ${l.toLocaleString('id-ID')}`);
            addRow("Uang Makan", `Rp ${m.toLocaleString('id-ID')}`);
            
            if(aVal !== 0) {
                 doc.setTextColor(aVal < 0 ? 200 : 0, 0, 0); // Red if minus
                 addRow(aDesc, `Rp ${aVal.toLocaleString('id-ID')}`);
                 doc.setTextColor(0,0,0);
            }

            y += 2;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            doc.line(5, y, 75, y);
            y += 6;

            // --- TOTAL ---
            doc.setFillColor(236, 252, 249); // Light Green bg
            doc.rect(5, y-5, 70, 10, 'F');
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 100, 0);
            doc.text("TOTAL TERIMA", 7, y+2);
            doc.text(`Rp ${total.toLocaleString('id-ID')}`, 73, y+2, {align:'right'});
            
            y += 10;

            // --- CATATAN ---
            if(note) {
                y += 5;
                doc.setTextColor(0,0,0);
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text("Catatan Admin:", 5, y);
                y += 4;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);
                const splitNote = doc.splitTextToSize(note, 70);
                doc.text(splitNote, 5, y);
                y += (splitNote.length * 3) + 5;
            } else {
                y += 10;
            }

            // --- FOOTER (NO SIGNATURE) ---
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(6);
            doc.text("Dokumen ini diterbitkan secara digital oleh sistem.", 40, y, {align:'center'});
            doc.text("Valid dan sah tanpa tanda tangan basah.", 40, y+3, {align:'center'});
            doc.text("Kenekozo Logistics System ¬© 2024", 40, y+6, {align:'center'});

            doc.save(`Slip_Gaji_${activeMission.date.replace(/\s/g, '_')}.pdf`);
        }

    </script>
</body>
</html>